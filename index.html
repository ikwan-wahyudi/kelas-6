<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal Nilai Siswa Kelas VI - SDN Bubulan II</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-slate-100 to-slate-200 min-h-screen py-6">
    <div class="max-w-3xl mx-auto bg-white/90 p-6 rounded-xl shadow-xl">
        <header class="flex items-center gap-4 border-b-4 border-blue-600 pb-4 mb-6">
            <img src="sd-negeri-bubulan-ii.png" alt="Logo Sekolah" class="w-16 h-16" />
            <div>
                <h2 class="text-xl font-bold text-blue-700">SD Negeri Bubulan II</h2>
                <p class="text-sm">Dukuh Tlotok, Desa Bubulan, Kecamatan Bubulan, Kabupaten Bojonegoro, Kode Pos 62172
                </p>
            </div>
        </header>

        <h2 class="text-xl font-bold text-center text-blue-700 mb-6">Portal Nilai Siswa Kelas VI</h2>

        <div id="loginForm">
            <label for="name" class="block font-semibold mb-1">Nama Siswa</label>
            <input type="text" id="name" placeholder="Masukkan nama lengkap"
                class="w-full mb-4 p-2 border border-gray-300 rounded-md">

            <label for="nis" class="block font-semibold mb-1">Nomor Induk Siswa (NIS)</label>
            <input type="number" id="nis" placeholder="Masukkan NIS"
                class="w-full mb-4 p-2 border border-gray-300 rounded-md">

            <button onclick="login()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md font-semibold">Login</button>
        </div>

        <div id="result" class="hidden">
            <h2 id="studentName" class="text-center text-xl font-bold text-blue-800 mb-4"></h2>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md mt-6 mb-6 text-sm text-gray-700">
                <p><strong>Update terakhir:</strong> <span id="update-date"></span></p>
                <p class="mt-2 text-justify">Portal nilai siswa ini adalah fitur bagi siswa dan orang tua/wali Kelas VI
                    SD Negeri Bubulan II untuk
                    memantau perkembangan hasil belajar secara berkala. Informasi yang ditampilkan adalah informasi
                    mingguan yang sifatnya
                    sementara (bukan final) dan dapat berubah seiring dengan perkembangan belajar anak.</p>
            </div>

            <div class="flex flex-wrap gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Mata Pelajaran</label>
                    <select id="filterSubject" onchange="applyFilterSort()"
                        class="p-2 border border-gray-300 rounded-md text-sm">
                        <option value="all">Semua</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Urutkan Nilai</label>
                    <select id="sortOption" onchange="applyFilterSort()"
                        class="p-2 border border-gray-300 rounded-md text-sm">
                        <option value="desc">Tertinggi ke Terendah</option>
                        <option value="asc">Terendah ke Tertinggi</option>
                    </select>
                </div>
            </div>

            <div id="scoreCards" class="flex flex-col gap-4"></div>
            <h3 id="summary" class="text-center font-semibold text-lg mt-6"></h3>

            <div class="mt-6">
                <canvas id="scoreChart" width="400" height="300"></canvas>
            </div>

            <div class="flex flex-col gap-2 mt-6">
                <button onclick="window.print()"
                    class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold">Cetak
                    Nilai</button>
                <button onclick="logout()"
                    class="bg-red-600 hover:bg-red-700 text-white py-2 rounded-md font-semibold">Kembali</button>
            </div>
        </div>

        <footer class="mt-10 text-center text-sm text-gray-600">
            <hr class="my-4 border-gray-300">
            <p>Website ini dikembangkan oleh <strong>Ikwan Wahyudi, S.Pd., M.Pd.</strong></p>
        </footer>
    </div>

    <script>
        let studentData = {};
        let currentGrades = [];
        let currentFilter = "all";
        let currentSort = "desc";

        const subjectIcons = {
            "Pendidikan Pancasila": "ðŸ‡®ðŸ‡©",
            "Bahasa Indonesia": "ðŸ“–",
            "Matematika": "âž—",
            "IPAS": "ðŸ”¬",
            "Seni dan Budaya": "ðŸŽ¨",
            "PJOK": "ðŸ¤¸",
            "Bahasa Inggris": "ðŸ‡¬ðŸ‡§",
            "Bahasa Jawa": "ðŸ“",
            "Literasi Digital": "ðŸ’»"
        };

        fetch("https://script.google.com/macros/s/AKfycbzEjblQsUHMpBejOv8YV2D4CAKa3bkbKoXFXJlyfGNeJbofsw-6dg7MTMFaFBjU1z4/exec")
            .then(response => response.json())
            .then(data => {
                studentData = data.students;
                const updateElem = document.getElementById("update-date");
                if (updateElem && data.updatedAt) {
                    const tanggal = new Date(data.updatedAt.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                    updateElem.textContent = formatTanggalIndonesiaLengkap(tanggal);
                }
            });

        function login() {
            const name = document.getElementById("name").value.trim().toLowerCase();
            const nis = document.getElementById("nis").value.trim();

            if (studentData[nis] && studentData[nis].name.toLowerCase() === name) {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("result").classList.remove("hidden");
                document.getElementById("studentName").innerText = `Selamat datang, ${studentData[nis].name}`;

                currentGrades = studentData[nis].grades;

                const subjectSelect = document.getElementById("filterSubject");
                const subjects = [...new Set(currentGrades.map(g => g.subject))];
                subjectSelect.innerHTML = `<option value="all">Semua</option>` +
                    subjects.map(sub => `<option value="${sub}">${sub}</option>`).join("");

                const total = currentGrades.reduce((sum, item) => sum + item.score, 0);
                const avg = (total / currentGrades.length).toFixed(2);
                const avgList = Object.entries(studentData).map(([key, value]) => {
                    const total = value.grades.reduce((sum, item) => sum + item.score, 0);
                    const avg = total / value.grades.length;
                    return { nis: key, avg: avg };
                }).sort((a, b) => b.avg - a.avg);
                const classRank = avgList.findIndex(item => item.nis === nis) + 1;

                document.getElementById("summary").innerText = `Rata-rata nilai: ${avg} | Peringkat kelas: ${classRank}`;
                applyFilterSort();
            } else {
                alert("Nama atau NIS tidak cocok.");
            }
        }

        function applyFilterSort() {
            currentFilter = document.getElementById("filterSubject").value;
            currentSort = document.getElementById("sortOption").value;
            renderScoreCards();
        }

        function renderScoreCards() {
            let filtered = [...currentGrades];
            if (currentFilter !== "all") {
                filtered = filtered.filter(item => item.subject === currentFilter);
            }
            filtered.sort((a, b) => currentSort === "asc" ? a.score - b.score : b.score - a.score);

            const labels = [];
            const scores = [];
            let content = "";

            filtered.forEach(item => {
                const color = item.score >= 70 ? 'bg-green-500' : 'bg-red-500';
                const fillWidth = Math.min(100, item.score) + "%";
                const icon = subjectIcons[item.subject] || "ðŸ“˜";

                labels.push(item.subject);
                scores.push(item.score);

                content += `
          <div class="border-l-4 bg-white p-4 rounded-md shadow-md">
            <h4 class="text-blue-700 font-bold text-lg">${icon} ${item.subject}</h4>
            <p class="text-sm mt-1"><strong>Nilai:</strong> ${item.score}</p>
            <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
              <div class="h-2 rounded-full ${color}" style="width: ${fillWidth};"></div>
            </div>
            <p class="text-sm mt-2"><strong>Catatan:</strong> ${item.note}</p>
            <p class="text-sm"><strong>Peringkat:</strong> ${item.rank}</p>
          </div>`;
            });

            document.getElementById("scoreCards").innerHTML = content;
            new Chart(document.getElementById("scoreChart"), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Nilai per Mata Pelajaran', data: scores, backgroundColor: scores.map(score => score >= 70 ? '#4caf50' : '#f44336') }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function logout() {
            document.getElementById("result").classList.add("hidden");
            document.getElementById("loginForm").classList.remove("hidden");
            document.getElementById("name").value = "";
            document.getElementById("nis").value = "";
            document.getElementById("studentName").innerText = "";
            document.getElementById("scoreCards").innerHTML = "";
            document.getElementById("summary").innerText = "";
            const canvas = document.getElementById("scoreChart");
            if (canvas && canvas.getContext) canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
        }

        function formatTanggalIndonesiaLengkap(tanggal) {
            const bulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            return `${tanggal.getDate()} ${bulan[tanggal.getMonth()]} ${tanggal.getFullYear()} ${String(tanggal.getHours()).padStart(2, '0')}:${String(tanggal.getMinutes()).padStart(2, '0')}:${String(tanggal.getSeconds()).padStart(2, '0')}`;
        }
    </script>
</body>

</html>
